<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Australian Court Chronicle</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
<script defer src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">


  <style>
    body{font-family:'Roboto',sans-serif}
    .headline-font{font-family:'Playfair Display',serif}
    .nav-link:hover{text-decoration:underline;text-underline-offset:8px;text-decoration-thickness:2px}
    .news-card:hover .news-title{text-decoration:underline}
    .news-card{transition:transform .2s ease, box-shadow .2s ease}
    .news-card:hover{transform:translateY(-4px);box-shadow:0 10px 25px -10px rgba(0,0,0,.2)}
    .hero-gradient{background:linear-gradient(180deg,rgba(0,0,0,.7) 0%,rgba(0,0,0,.35) 100%)}
    .section{display:none}
    .section.active{display:block}
    .article-content span{margin-right:.4em;display:inline-block}
    .article-content p{margin-bottom:1rem;line-height:1.6}
    .article-content p:last-child{margin-bottom:0}
    .article-content p,.article-content ul,.article-content ol,.article-content blockquote{margin-bottom:1rem}
    .aspect-video{position:relative;padding-top:56.25%}
    .aspect-video>iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    .breaking{animation:pulse 2s infinite}
    @keyframes pulse{0%{background:#dc2626}50%{background:#b91c1c}100%{background:#dc2626}}

  .article-content img,
.article-content figure,
.article-content iframe,
.article-content video {
  max-width: 100%;
  height: auto;
}

.article-content figure {
  margin-left: 0;
  margin-right: 0;
}

.article-content * {
  overflow-wrap: anywhere;
}

.article-content table {
  display: block;
  max-width: 100%;
  overflow-x: auto;
}

  </style>
</head>
<body class="bg-gray-50">

<!-- Breaking strip -->
<div
  id="breaking-strip"
  style="display:none; background:#dc2626;"
  class="breaking py-2 px-4 text-white text-center font-medium">
  <div class="container mx-auto flex items-center justify-center">
    <span class="mr-2 font-bold">BREAKING:</span>
    <span class="truncate">Live: major judgment handed down. Full coverage and analysis inside.</span>
  </div>
</div>



  <!-- Header -->
  <header class="border-b border-gray-200 bg-white sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <a href="#home" data-section="home" class="headline-font text-2xl md:text-3xl font-bold text-gray-900">The Australian Court Chronicle</a>
        <div class="flex items-center gap-3">
          <button class="hidden md:inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Subscribe</button>
          <button id="open-menu" class="md:hidden p-2" aria-label="Open menu"><i data-feather="menu"></i></button>
        </div>
      </div>
      <nav id="top-nav" class="hidden md:flex gap-6 mt-3 text-sm md:text-base"></nav>
    </div>
  </header>
  <!-- Full width category banner -->
  <div id="category-banner" class="hidden bg-blue-900 text-white py-4">
    <div class="container mx-auto px-4">
      <h1 id="category-banner-title" class="headline-font text-2xl md:text-3xl font-bold"></h1>
      <p id="category-banner-subtitle" class="opacity-90"></p>
    </div>
  </div>



  <!-- Mobile menu -->
<aside id="mobile-menu" class="md:hidden fixed inset-0 bg-black/40 hidden z-[9999]">
    <div class="absolute right-0 top-0 bottom-0 w-64 bg-white shadow-lg p-4">
      <div class="flex items-center justify-between mb-4">
        <span class="font-bold">Menu</span>
        <button id="close-menu" class="p-2" aria-label="Close menu"><i data-feather="x"></i></button>
      </div>
      <nav id="mobile-nav" class="flex flex-col space-y-2"></nav>
    </div>
  </aside>

  <!-- Main root -->
  <main id="root" class="container mx-auto px-4 my-8"></main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white mt-16">
    <div class="container mx-auto px-4 py-12">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
        <div>
          <h3 class="headline-font text-xl font-bold mb-4">The Australian Court Chronicle</h3>
          <p class="text-gray-400 text-sm">Independent coverage of courts and the law.</p>
        </div>
        <div>
          <h4 class="font-bold mb-4">Sections</h4>
          <ul id="footer-nav" class="space-y-2 text-gray-300"></ul>
        </div>
        <div>
          <h4 class="font-bold mb-4">Company</h4>
          <ul class="space-y-2 text-gray-300">
            <li><a href="#" class="hover:text-white">About</a></li>
            <li><a href="#" class="hover:text-white">Contact</a></li>
            <li><a href="#" class="hover:text-white">Ethics</a></li>
          </ul>
        </div>
        <div>
          <h4 class="font-bold mb-4">Newsletter</h4>
          <p class="text-gray-300 text-sm mb-3">Daily legal brief in your inbox.</p>
          <div class="flex gap-2">
            <input type="email" placeholder="Your email" class="px-3 py-2 rounded bg-gray-800 border border-gray-700 text-sm w-full">
            <button class="bg-blue-600 hover:bg-blue-700 px-4 rounded">Join</button>
          </div>
          <p class="text-gray-500 text-xs mt-2">We respect your privacy.</p>
        </div>
      </div>
      <div class="border-t border-gray-800 mt-8 pt-6 text-gray-500 text-sm">© <span id="year"></span> Court Chronicle. All rights reserved.</div>
    </div>
  </footer>

<script>
(function(){
  "use strict";

  const API = "https://wp.thenewdaily.com.au/wp-json/wp/v2/posts";

  const CATS = [
    { key: "home", label: "Home", type: "home" },
    { key: "highcourt", label: "High Court", type: "category", search: "high Court", tagline: "Latest from the High Court of Australia" },
    { key: "federal", label: "Federal Court", type: "category", search: "federal AND court", tagline: "Decisions and filings across the Federal Court" },
    { key: "state", label: "NSW Courts", type: "category", search: "NSW AND Court", tagline: "Key rulings across the states and territories" },
    { key: "tribunals", label: "Tribunals", type: "category", search: "tribunal OR appeal", tagline: "Significant tribunal decisions and trends" },
    { key: "analysis", label: "Legal Analysis", type: "category", search: "law AND review", tagline: "Explainers and expert commentary" },
    { key: "judges", label: "Judges", type: "category", search: "judge OR magistrate", tagline: "Appointments, retirements and profiles" },
    { key: "Cyber", label: "Cyber Crime", type: "category", search: "cyber OR hacker OR breach", tagline: "Technology and Law" },
    { key: "Tax", label: "Tax", type: "category", search: "tax OR ato", tagline: "ato OR tax" },
      { key: "Corruption", label: "Corruption", type: "category", search: "corruption", tagline: "Corruption" }

  ];

  var maxstories = 10;


  const loaded   = Object.fromEntries(CATS.map(c => [c.key, false]));
  const inflight = Object.fromEntries(CATS.map(c => [c.key, false]));
  const seen     = Object.fromEntries(CATS.map(c => [c.key, new Set()]));
  const cache    = new Map();
  const seenAll  = new Set();

  const qs = (sel, el=document) => el.querySelector(sel);
  const qsa = (sel, el=document) => Array.from(el.querySelectorAll(sel));
  const fmtDate = (iso) => new Date(iso).toLocaleDateString();

  const TTL_MS = 60 * 60 * 1000;
  const LS = {
    lastFetch: "cc:lastFetch",
    feed: (key) => `cc:feed:${key}`,
    post: (id) => `article-${id}`,
  };

  const HOME_OVERRIDES = {
    enabled: false,              // flip this on/off
    index: 1,                   // 0 = hero, 1 = first card in the grid, 2 = second card, etc
    article: {
      id: "custom-home-1",      // string id is fine for custom content
      date: new Date().toISOString(),
      title: { rendered: "My Exclusive: Why this judgment matters" },
      yoast_head_json: {
        description: "A short deck explaining the key issue, what the orders do, and what happens next.",
        author: "Chris"
      },
      _custom: true,            // marker so we can handle it safely
      _custom_image: "https://picsum.photos/1200/800", // or your own hosted image
      content: { rendered: "<p>Your full article HTML here.</p><p>Second paragraph.</p>" }
    }
  };





  function now(){ return Date.now(); }
  function isFresh(){
    const t = Number(localStorage.getItem(LS.lastFetch) || "0");
    return (now() - t) < TTL_MS;
  }
  function markFetchedNow(){
    localStorage.setItem(LS.lastFetch, String(now()));
  }

  function imgFrom(post){
    if (!post) return "";
    if (post._custom && post._custom_image) return post._custom_image;

    const yo = post?.yoast_head_json?.og_image?.[0]?.url;
    if (yo) return yo;
    return post?._embedded?.["wp:featuredmedia"]?.[0]?.source_url || "";
  }
  function applyHomeOverrides(posts){
    if (!HOME_OVERRIDES?.enabled) return posts;
    if (!Array.isArray(posts) || !posts.length) return posts;

    const idx = Number(HOME_OVERRIDES.index ?? 1);
    const custom = HOME_OVERRIDES.article;

    if (!custom) return posts;

    // Make a shallow copy so we don't mutate original
    const out = posts.slice();

    // Ensure the list is long enough to place the custom card
    while (out.length <= idx) out.push(null);

    out[idx] = custom;
    return out.filter(Boolean);
  }


  function storePost(p){
    if (!p || !p.id) return;
    cache.set(p.id, p);
    try { localStorage.setItem(LS.post(p.id), JSON.stringify(p)); } catch {}
  }
  function getPost(id){
    if (!id) return null;
    const n = Number(id);
    if (cache.has(n)) return cache.get(n);
    try {
      const s = localStorage.getItem(LS.post(n));
      if (s){
        const p = JSON.parse(s);
        cache.set(n, p);
        return p;
      }
    } catch {}
    return null;
  }

  function storeFeed(key, posts){
    try {
      const ids = posts.map(p => p.id);
      localStorage.setItem(LS.feed(key), JSON.stringify(ids));
    } catch {}
  }
  function loadFeedIds(key){
    try {
      const raw = localStorage.getItem(LS.feed(key));
      if (!raw) return [];
      const ids = JSON.parse(raw);
      return Array.isArray(ids) ? ids : [];
    } catch { return []; }
  }

  function transformEmbeds(html){
    if (!html) return "";
    return html.replace(/\[jwplayer\s*=\s*([^\]\s]+)\]/gi, (m,id) => {
      return `<div class="my-4 p-3 bg-gray-100 text-center rounded text-gray-700">Video unavailable (<code>${id}</code>)</div>`;
    });
  }

  const tpl = {
    navLink: (c) => `<a href="#${c.key}" data-section="${c.key}" class="nav-link">${c.label}</a>`,
    footerLink: (c) => `<li><a href="#${c.key}" data-section="${c.key}" class="hover:text-white">${c.label}</a></li>`,

    hero: (post,prefix) => `
      <section class="mb-12" data-aos="fade-up">
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="md:flex">
            <div class="md:w-2/3">
              <img
                src="${imgFrom(post)}"
                alt="${post.title.rendered}"
                loading="eager"
                fetchpriority="high"
                decoding="async"
                class="w-full h-full object-cover"
              />
            </div>
            <div class="p-6 md:w-1/3">
              <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded">FEATURED</span>
              <h1 id="${prefix}-title" class="headline-font text-3xl md:text-4xl font-bold mt-2 mb-4">${post.title.rendered}</h1>
              <p id="${prefix}-excerpt" class="text-gray-600 mb-4">${post?.yoast_head_json?.description || ""}</p>
              <div class="flex items-center text-sm text-gray-500">
                <span>By Elizabeth Thompson</span>
                <span class="mx-2">•</span>
                <span>${fmtDate(post.date)}</span>
              </div>
              <button data-story-id="${post.id}" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full font-medium">Read Full Story</button>
            </div>
          </div>
        </div>
      </section>`,

    featured: (post, prefix) => `
      <section class="mb-12" data-aos="fade-up">
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="md:flex">
            <div class="md:w-2/3">
              <img src="${imgFrom(post)}" alt="${post.title.rendered}">
            </div>
            <div class="p-6 md:w-1/3">
              <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded">FEATURED</span>
              <h1 id="${prefix}-title" class="headline-font text-3xl md:text-4xl font-bold mt-2 mb-4">${post.title.rendered}</h1>
              <p id="${prefix}-excerpt" class="text-gray-600 mb-4">${post?.yoast_head_json?.description || ""}</p>
              <div class="flex items-center text-sm text-gray-500">
                <span>By Elizabeth Thompson</span>
                <span class="mx-2">•</span>
                <span>${fmtDate(post.date)}</span>
              </div>
              <button data-story-id="${post.id}" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full font-medium">Read Full Story</button>
            </div>
          </div>
        </div>
      </section>`,

    gridWrap: (title, feedId) => `
      <section class="mb-12">
        <h2 class="headline-font text-2xl font-bold mb-6 border-b border-gray-200 pb-2">${title}</h2>
        <div id="${feedId}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </section>`,

card: (post) => `
  <div class="bg-white rounded-lg overflow-hidden shadow-sm news-card">
    <a href="#story-${post.id}" data-story-id="${post.id}" class="block">
      <img
        src="${imgFrom(post)}"
        alt=""
        loading="lazy"
        decoding="async"
        class="w-full h-48 object-cover block"
        data-story-id="${post.id}"
        onerror="this.style.display='none'">
      <div class="p-4">
        <span class="text-xs text-gray-500">
          ${post?.yoast_head_json?.author || "Unknown"} • ${fmtDate(post.date)}
        </span>
        <h3 class="news-title headline-font font-bold text-lg my-2">
          ${post.title.rendered}
        </h3>
        <p class="text-gray-600 text-sm">
          ${post?.yoast_head_json?.description || ""}
        </p>
      </div>
    </a>
  </div>
`,


    storyShell: () => `
      <div id="story" class="section">
        <main class="container mx-auto px-4 my-8">
          <article class="max-w-4xl mx-auto">
            <header class="mb-8">
              <div class="mb-4 text-sm text-gray-500"><span id="article-date"></span></div>
              <h1 class="headline-font text-3xl md:text-4xl font-bold mb-4" id="article-title"></h1>
              <p class="text-xl text-gray-600 mb-6" id="article-excerpt"></p>
              <div class="flex items-center" id="article-author-box" style="display:none;">
                <div class="w-10 h-10 rounded-full bg-gray-300 mr-3 overflow-hidden">
                  <img id="article-author-img" src="https://thispersondoesnotexist.com" alt="Author" class="w-full h-full object-cover" />
                </div>
                <div>
                  <p class="font-medium">By <span id="article-author"></span></p>
                  <p class="text-sm text-gray-500">Court Chronicle Correspondent</p>
                </div>
              </div>
            </header>
            <div class="mb-8" id="article-image-box" style="display:none;">
              <img id="article-image" alt="" class="w-full h-auto rounded-lg" />
            </div>
            <div class="article-content text-gray-800 mb-12" id="article-content"></div>
            <button id="back-button" class="mt-6 text-blue-700 font-medium">← Back</button>
          </article>
        </main>
      </div>`
  };

  function parseHash(){
    const raw = (location.hash||"").replace('#','');
    const m = raw.match(/^story[-=](\d+)$/);
    return m ? { type:'story', id:m[1] } : { type: raw || 'home' };
  }

  function mountShells(){
    const root = qs('#root');
    root.innerHTML = '';

    const homeEl = document.createElement('div');
    homeEl.id = 'home';
    homeEl.className = 'section active';
    homeEl.innerHTML = `
      <section id="home-hero-slot" class="mb-8">
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
          <div class="md:flex">
            <div class="md:w-2/3">
              <div class="w-full h-64 md:h-96 bg-gray-200 animate-pulse"></div>
            </div>
            <div class="p-6 md:w-1/3">
              <div class="h-4 w-24 bg-gray-200 rounded animate-pulse"></div>
              <div class="mt-3 h-8 w-full bg-gray-200 rounded animate-pulse"></div>
              <div class="mt-2 h-8 w-3/4 bg-gray-200 rounded animate-pulse"></div>
              <div class="mt-4 h-4 w-full bg-gray-200 rounded animate-pulse"></div>
              <div class="mt-2 h-4 w-5/6 bg-gray-200 rounded animate-pulse"></div>
              <div class="mt-6 h-10 w-40 bg-gray-200 rounded-full animate-pulse"></div>
            </div>
          </div>
        </div>
      </section>
      ${tpl.gridWrap('Latest legal stories', 'home-feed')}
    `;
    root.appendChild(homeEl);

    for (const c of CATS.filter(x => x.type==='category')){
      const div = document.createElement('div');
      div.id = c.key;
      div.className = 'section';
      div.innerHTML = `
        <section class="mb-12"><div id="${c.key}-featured-slot"></div></section>
        ${tpl.gridWrap('Latest', c.key+'-feed')}
      `;
      root.appendChild(div);
    }

    const storyWrap = document.createElement('div');
    storyWrap.innerHTML = tpl.storyShell();
    root.appendChild(storyWrap.firstElementChild);
  }

  function mountNavs(){
    qs('#top-nav').innerHTML = CATS.map(tpl.navLink).join('');
    qs('#mobile-nav').innerHTML = CATS.map(c=>`<a href="#${c.key}" data-section="${c.key}" class="p-2 rounded hover:bg-gray-100">${c.label}</a>`).join('');
    qs('#footer-nav').innerHTML = CATS.map(tpl.footerLink).join('');
  }

  function setBanner(sectionKey){
    const banner = qs('#category-banner');
    const titleEl = qs('#category-banner-title');
    const subEl = qs('#category-banner-subtitle');
    const cfg = CATS.find(c=>c.key===sectionKey);
    const isCat = cfg && cfg.type==='category';
    if (isCat){
      titleEl.textContent = cfg.label;
      subEl.textContent = cfg.tagline || '';
      banner.classList.remove('hidden');
    } else {
      banner.classList.add('hidden');
      titleEl.textContent = '';
      subEl.textContent = '';
    }
  }

  function pumpCards(container, key, posts){
    let i = 0;
    const s = seen[key];
    function step(){
      if (i >= posts.length) return;
      const p = posts[i++];
      if (!p || !p.id) return scheduleNext();
      if (!s.has(p.id)){
        s.add(p.id);
        container.insertAdjacentHTML('beforeend', tpl.card(p));
      }
      scheduleNext();
    }
    function scheduleNext(){
      if ('requestIdleCallback' in window) requestIdleCallback(step);
      else setTimeout(step, 40);
    }
    step();
  }

  function clearFeedUI(key){
    if (key === 'home'){
      const feed = qs('#home-feed');
      if (feed) feed.innerHTML = '';
    } else {
      const feed = qs(`#${key}-feed`);
      if (feed) feed.innerHTML = '';
      const feat = qs(`#${key}-featured-slot`);
      if (feat) feat.innerHTML = '';
    }
  }

  function hydrateSectionFromCache(key){
    const ids = loadFeedIds(key);
    if (!ids.length) return false;

    const posts = ids.map(id => getPost(id)).filter(Boolean);
    if (!posts.length) return false;

    posts.forEach(p => seenAll.add(p.id));

    clearFeedUI(key);

    if (key === 'home'){
      const hero = posts[0];
      if (hero){
        qs('#home-hero-slot').innerHTML = tpl.hero(hero, 'home');
      }
      const rest = posts.slice(1, maxstories);
      pumpCards(qs('#home-feed'), 'home', rest);
    } else {
      const cfg = CATS.find(c => c.key === key);
      const featured = posts[0];
      if (featured && cfg){
        qs(`#${cfg.key}-featured-slot`).innerHTML = tpl.featured(featured, cfg.key);
      }
      const rest = posts.slice(1, maxstories);
      pumpCards(qs(`#${key}-feed`), key, rest);
    }

    loaded[key] = true;
    inflight[key] = false;
    return true;
  }

  async function fetchPosts(query){
    const url = new URL(API);
    Object.entries(query).forEach(([k,v]) => url.searchParams.set(k,v));
    try{
      const res = await fetch(url.toString());
      if (!res.ok) throw new Error('Bad response');
      const data = await res.json();
      return Array.isArray(data) ? data : [];
    } catch {
      return [];
    }
  }

  async function loadBySearch(term, wantCount){
    const perPage = Math.min(100, wantCount * 2);
    let page = 1;
    const out = [];

    while(out.length < wantCount && page <= 6){
      const batch = await fetchPosts({ per_page: perPage, page, _embed: '', search: term });
      if (!batch.length) break;

      for (const p of batch){
        if (!seenAll.has(p.id)){
          out.push(p);
          if (out.length >= wantCount) break;
        }
      }

      if (batch.length < perPage) break;
      page += 1;
    }

    return out;
  }

  async function fetchAndRenderHome(){
    let data = await loadBySearch('court OR law OR legal', maxstories);
    if (!data.length) return;

    // Inject your custom post into the chosen slot
    data = applyHomeOverrides(data);

    // Only store/mark real WP posts (numeric ids)
    data.forEach(p => {
      if (p && typeof p.id === "number"){
        seenAll.add(p.id);
        storePost(p);
      }
    });

    const heroImg = imgFrom(data[0]);
    if (heroImg){
      const link = document.createElement('link');
      link.rel = 'preload';
      link.as = 'image';
      link.href = heroImg;
      document.head.appendChild(link);
    }

    clearFeedUI('home');
    qs('#home-hero-slot').innerHTML = tpl.hero(data[0], 'home');

    // Grid cards (skip hero)
    pumpCards(qs('#home-feed'), 'home', data.slice(1, maxstories));

    // Store feed ids, but only numeric WP ids
    storeFeed('home', data.filter(p => typeof p.id === "number").slice(0, maxstories));
  }


  async function fetchAndRenderCategory(catKey){
    const cfg = CATS.find(c => c.key === catKey);
    if (!cfg) return;

    const data = await loadBySearch(cfg.search, maxstories);
    if (!data.length) return;

    data.forEach(p => { seenAll.add(p.id); storePost(p); });

    clearFeedUI(catKey);

    const featured = data[0];
    if (featured){
      qs(`#${cfg.key}-featured-slot`).innerHTML = tpl.featured(featured, cfg.key);
    }

    pumpCards(qs(`#${cfg.key}-feed`), cfg.key, data.slice(1, maxstories));

    storeFeed(cfg.key, data.slice(0, maxstories));
  }

  function showSection(id){
    window.scrollTo(0,0);

    qsa('.section').forEach(s => s.classList.remove('active'));
    const target = qs('#'+(id||'home')) || qs('#home');
    target.classList.add('active');

    setBanner(id);

    const key = id || 'home';

    if (!loaded[key] && !inflight[key]){
      inflight[key] = true;

      const fresh = isFresh();
      const didHydrate = fresh ? hydrateSectionFromCache(key) : false;

      if (didHydrate){
        inflight[key] = false;
        return;
      }

      const runFetch = async () => {
        try {
          if (key === 'home') await fetchAndRenderHome();
          else if (CATS.find(c => c.key === key && c.type === 'category')) await fetchAndRenderCategory(key);
          markFetchedNow();
        } finally {
          loaded[key] = true;
          inflight[key] = false;
        }
      };

      runFetch();
    }
  }

  function getCustomPostById(id){
    const a = HOME_OVERRIDES?.article;
    if (HOME_OVERRIDES?.enabled && a && String(a.id) === String(id)) return a;
    return null;
  }


  async function showStory(id){
    let data = getCustomPostById(id) || getPost(id);

    if (!data && typeof id === "string"){
      // custom string id not found, avoid WP fetch
      data = null;
    }

    if (!data){
      try{
        const res = await fetch(`${API}/${id}?_embed`);
        if (res.ok){
          data = await res.json();
          storePost(data);
        }
      } catch {}
    }

    // rest of your showStory stays the same...

    const setText = (sel, val) => { const el = qs(sel); if (el) el.textContent = val || ''; };
    const setHTML = (sel, val) => { const el = qs(sel); if (el) el.innerHTML = val || ''; };

    if (!data){
      setText('#article-title','Article not found');
      setHTML('#article-content','<p class="text-center text-gray-500">Sorry, we could not load this story.</p>');
      setBanner('');
      qsa('.section').forEach(s => s.classList.remove('active'));
      qs('#story').classList.add('active');
      window.scrollTo(0,0);
      return;
    }

    setHTML('#article-title', data.title.rendered);
    setText('#article-excerpt', data?.yoast_head_json?.description || '');
    setHTML('#article-content', transformEmbeds(data?.content?.rendered || ''));
    setText('#article-date', fmtDate(data.date));

    const author = data?.yoast_head_json?.author;
    const box = qs('#article-author-box');
    if (author){
      qs('#article-author').textContent = author;
      box.style.display = 'flex';
    } else {
      box.style.display = 'none';
    }

    const img = imgFrom(data);
    const imgBox = qs('#article-image-box');
    if (img){
      const el = qs('#article-image');
      el.src = img;
      el.alt = data.title.rendered;
      imgBox.style.display = 'block';
    } else {
      imgBox.style.display = 'none';
    }

    setBanner('');
    if (location.hash !== `#story-${id}`) location.hash = `#story-${id}`;

    qsa('.section').forEach(s => s.classList.remove('active'));
    qs('#story').classList.add('active');
    window.scrollTo(0,0);
  }

  function shouldPrefetchBackground(){
    return !isFresh();
  }

  function prefetchOthersAfter(firstKey){
    if (!shouldPrefetchBackground()) return;

    const conn = navigator.connection;
    const slow = conn && (conn.saveData || /2g/.test(conn.effectiveType || ""));
    const delay = slow ? 4000 : 900;

    setTimeout(() => {
      const run = () => {
        for (const c of CATS){
          const key = c.key;
          if (key === firstKey) continue;

          if (loaded[key] || inflight[key]) continue;

          inflight[key] = true;

          const task = async () => {
            try{
              if (key === 'home') await fetchAndRenderHome();
              else if (c.type === 'category') await fetchAndRenderCategory(key);
              markFetchedNow();
            } finally {
              loaded[key] = true;
              inflight[key] = false;
            }
          };

          task();
        }
      };

      if ('requestIdleCallback' in window) requestIdleCallback(run);
      else setTimeout(run, 0);
    }, delay);
  }

  function openMenu(){ qs('#mobile-menu').classList.remove('hidden'); }
  function closeMenu(){ qs('#mobile-menu').classList.add('hidden'); }

  document.addEventListener('click', (e) => {
    const sec = e.target.closest('[data-section]');
    if (sec){
      e.preventDefault();
      const id = sec.getAttribute('data-section') || 'home';
      closeMenu();
      if (location.hash !== `#${id}`) location.hash = `#${id}`;
      showSection(id);

      setTimeout(() => prefetchOthersAfter(id), 0);
      return;
    }

    const story = e.target.closest('[data-story-id]');
    if (story){
      e.preventDefault();
      const id = story.getAttribute('data-story-id');
      closeMenu();
      if (id) showStory(id);
    }
  });

document.addEventListener('click', (e) => {
  const sec = e.target.closest('[data-section]');
  if (sec){
    e.preventDefault();
    const id = sec.getAttribute('data-section') || 'home';
    closeMenu();
    if (location.hash !== `#${id}`) location.hash = `#${id}`;
    showSection(id);
    setTimeout(() => prefetchOthersAfter(id), 0);
    return;
  }

  const storyEl = e.target.closest('a[data-story-id], [data-story-id]');
  if (storyEl){
    e.preventDefault();
    const id = storyEl.getAttribute('data-story-id');
    closeMenu();
    if (id) showStory(id);
  }
});

  window.addEventListener('hashchange', () => {
    const h = parseHash();
    if (h.type === 'story') { showStory(h.id); return; }

    const key = h.type || 'home';
    showSection(key);
    setTimeout(() => prefetchOthersAfter(key), 0);
  });

  document.addEventListener('DOMContentLoaded', () => {
    const strip = document.getElementById('breaking-strip');
    if (strip) strip.style.display = 'block';

    const y = document.getElementById('year');
    if (y) y.textContent = new Date().getFullYear();

    mountShells();
    mountNavs();

    const h = parseHash();

    if (h.type === 'story'){
      showStory(h.id);
      return;
    }

    const firstKey = h.type || 'home';

    showSection(firstKey);

    if (shouldPrefetchBackground()){
      setTimeout(() => prefetchOthersAfter(firstKey), 0);
    }

    requestAnimationFrame(() => {
      if (window.AOS?.init) AOS.init();
      if (window.feather?.replace) feather.replace();
    });
  });

  document.getElementById('open-menu').addEventListener('click', openMenu);
  document.getElementById('close-menu').addEventListener('click', closeMenu);
  qs('#mobile-menu').addEventListener('click', (e) => { if (e.target.id === 'mobile-menu') closeMenu(); });

  window.app = { showSection, showStory };
})();
</script>

</body>
</html>